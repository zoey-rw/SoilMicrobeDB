library(tidyverse)
library(ggpubr)
library(rstatix)
library(ggstatsplot)

source("scripts/helper_functions.r")

# Load biome data
if(!exists("soilCores")) {
    soilCores <- load_soilCores()
}

# Read classification rates from classification_pct_by_rank_per_sample.csv
# This includes all samples that completed Kraken classification
# Generated by scripts/run_workflow/06_calculate_classification_pct_by_rank.r
classification_file <- if(file.exists("data/classification/analysis_files/classification_pct_by_rank_per_sample.csv")) {
    "data/classification/analysis_files/classification_pct_by_rank_per_sample.csv"
} else {
    "data/NEON_metagenome_classification/summary_files/classification_pct_by_rank_per_sample.csv"
}

if(!file.exists(classification_file)) {
    stop("classification_pct_by_rank_per_sample.csv not found. Please run 06_calculate_classification_pct_by_rank.r first.")
}

classification_df <- read_csv(classification_file, show_col_types = FALSE) %>%
    filter(taxonomic_rank == "species",
           taxon_group == "all_domain",
           filter_status == "before",
           db_name %in% c("soil_microbe_db", "pluspf", "gtdb_207_unfiltered")) %>%
    mutate(percent_classified = pct_classified) %>%
    select(sampleID, db_name, percent_classified)

# Join with biome data
soilCores_subset <- soilCores %>% 
    select(compositeSampleID, nlcdClass) %>% 
    distinct(compositeSampleID, .keep_all = TRUE) %>% 
    filter(!is.na(compositeSampleID), !is.na(nlcdClass))

classification_biome <- left_join(classification_df %>%
                                     mutate(compositeSampleID = sampleID), 
                                 soilCores_subset, 
                                 by = "compositeSampleID") %>%
    filter(!is.na(nlcdClass))

# Perform Tukey test for each database
classification_tukey_list <- list()
for(db in unique(classification_biome$db_name)) {
    df_subset <- classification_biome %>% 
        filter(db_name == db, !is.na(percent_classified), !is.na(nlcdClass))
    
    if(nrow(df_subset) > 0 && length(unique(df_subset$nlcdClass)) > 1) {
        tukey_result <- tryCatch({
            microbialForecast::tukey(df_subset$nlcdClass, df_subset$percent_classified, y.offset = 0) %>% 
                mutate(db_name = db)
        }, error = function(e) NULL)
        
        if(!is.null(tukey_result)) {
            classification_tukey_list[[db]] <- tukey_result
        }
    }
}

classification_tukey <- bind_rows(classification_tukey_list)

# Order NLCD classes by median classification rate
nlcd_order <- classification_biome %>%
    group_by(nlcdClass) %>%
    summarize(median_classified = median(percent_classified, na.rm = TRUE)) %>%
    arrange(-median_classified) %>%
    pull(nlcdClass)

classification_biome$nlcdClass <- factor(classification_biome$nlcdClass, levels = nlcd_order)

# Create figure
fig_classification_rates <- ggplot(classification_biome, 
                aes(y = percent_classified, x = nlcdClass, color = db_name)) +
    geom_violin(aes(fill = db_name), draw_quantiles = c(.5), 
                position = position_dodge(width = 0.7), alpha = 0.3, show.legend = F) +
    geom_point(aes(color = db_name, fill = db_name),
           size = 2, alpha = 0.4, show.legend = T,
           position = position_jitterdodge(dodge.width = 0.7, jitter.width = 0.2, jitter.height = 0.01)) +
    ylab("% reads classified") + 
    xlab("NLCD Class") +
    theme_bw(base_size = 16) +
    theme(axis.text.x = element_text(angle = 310, vjust = .5, hjust = 0),
          axis.title = element_text(face = "bold"), 
          legend.title = element_text(face = "bold"), 
          legend.position = "right",
          plot.margin = unit(c(1,25,1,10), "pt")) +
    scale_color_brewer(palette = "Set1", name = "Database") +
    scale_fill_brewer(palette = "Set1", name = "Database")

# Add Tukey test labels
if(nrow(classification_tukey) > 0) {
    tukey_plot_data <- classification_tukey %>%
        mutate(nlcdClass = x, y.position = tot + 0.5)
    
    fig_classification_rates <- fig_classification_rates +
        geom_text(data = tukey_plot_data, 
                  aes(x = nlcdClass, y = y.position, label = Letters_Tukey, group = db_name),
                  position = position_dodge(width = 0.7),
                  show.legend = F, color = 1, size = 4)
}

ggsave("manuscript_figures/classification_rates_by_biome.png", 
       fig_classification_rates, width = 12, height = 8, units = "in", dpi = 300)

