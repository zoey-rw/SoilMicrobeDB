library(tidyverse)
library(ggpubr)
library(rstatix)
library(ggstatsplot)
library(patchwork)

source("scripts/helper_functions.r")

# Load biome data
if(!exists("soilCores")) {
    soilCores <- load_soilCores()
}

# Read classification rates from classification_pct_by_rank_per_sample.csv
# Generated by scripts/run_workflow/06_calculate_classification_pct_by_rank.r
# Using species-level data for manuscript figure
classification_file <- "data/NEON_metagenome_classification/analysis_files/classification_pct_by_rank_per_sample.csv"
if(!file.exists(classification_file)) {
    classification_file <- "data/classification/analysis_files/classification_pct_by_rank_per_sample.csv"
}

if(!file.exists(classification_file)) {
    stop("classification_pct_by_rank_per_sample.csv not found. Expected locations:\n",
         "  - data/NEON_metagenome_classification/analysis_files/classification_pct_by_rank_per_sample.csv\n",
         "  - data/classification/analysis_files/classification_pct_by_rank_per_sample.csv\n",
         "Please run 06_calculate_classification_pct_by_rank.r first.")
}

# Filter to species-level data and reshape to match expected format
classification_df <- read_csv(classification_file, show_col_types = FALSE) %>%
    filter(taxonomic_rank == "species",
           taxon_group == "all_domain",
           db_name %in% c("soil_microbe_db", "pluspf", "gtdb_207_unfiltered")) %>%
    mutate(
        Database = recode(db_name,
                          "soil_microbe_db" = "SoilMicrobeDB",
                          "gtdb_207_unfiltered" = "GTDB 207",
                          "pluspf" = "PlusPF"),
        # Create metric column to match old format
        metric = case_when(
            filter_status == "before" ~ "percent_classified",
            filter_status == "after" ~ "percent_passing"
        ),
        percent_value = pct_classified
    ) %>%
    select(sampleID, db_name, Database, metric, percent_value) %>%
    filter(!is.na(percent_value))

# Join with biome data
soilCores_subset <- soilCores %>% 
    select(compositeSampleID, nlcdClass) %>% 
    distinct(compositeSampleID, .keep_all = TRUE) %>% 
    filter(!is.na(compositeSampleID), !is.na(nlcdClass))

classification_biome <- left_join(classification_df %>%
                                     mutate(compositeSampleID = sampleID), 
                                 soilCores_subset, 
                                 by = "compositeSampleID") %>%
    filter(!is.na(nlcdClass))

# Separate data for before and after filtering
classification_before <- classification_biome %>%
    filter(metric == "percent_classified")

classification_after <- classification_biome %>%
    filter(metric == "percent_passing")

# Function to perform Tukey test
# Compare databases within each biome (not biomes within each database)
perform_tukey <- function(data_df) {
    tukey_list <- list()
    for(biome in unique(data_df$nlcdClass)) {
        df_subset <- data_df %>% 
            filter(nlcdClass == biome, !is.na(percent_value), !is.na(Database))
        
        if(nrow(df_subset) > 0 && length(unique(df_subset$Database)) > 1) {
            tukey_result <- tryCatch({
                microbialForecast::tukey(df_subset$Database, df_subset$percent_value, y.offset = 0) %>% 
                    mutate(nlcdClass = biome)
            }, error = function(e) NULL)
            
            if(!is.null(tukey_result)) {
                tukey_list[[biome]] <- tukey_result
            }
        }
    }
    return(bind_rows(tukey_list))
}

# Perform Tukey tests for both metrics
classification_tukey_before <- perform_tukey(classification_before)
classification_tukey_after <- perform_tukey(classification_after)

# Order NLCD classes by median classification rate (using before filtering data)
nlcd_order <- classification_before %>%
    group_by(nlcdClass) %>%
    summarize(median_classified = median(percent_value, na.rm = TRUE)) %>%
    arrange(-median_classified) %>%
    pull(nlcdClass)

classification_before$nlcdClass <- factor(classification_before$nlcdClass, levels = nlcd_order)
classification_after$nlcdClass <- factor(classification_after$nlcdClass, levels = nlcd_order)

# Colorblind-friendly palette (Okabe-Ito inspired)
myColors <- c("SoilMicrobeDB" = "#E69F00",  # Orange
              "GTDB 207" = "#56B4E9",       # Sky blue
              "PlusPF" = "#009E73")         # Bluish green
colScale <- scale_colour_manual(name = "Database", values = myColors)
fillScale <- scale_fill_manual(name = "Database", values = myColors)

# Function to create a plot panel
create_panel <- function(data_df, tukey_df, y_label, title_label) {
    p <- ggplot(data_df, 
                aes(y = percent_value, x = nlcdClass, color = Database)) +
        geom_violin(aes(fill = Database), 
                    position = position_dodge(width = 0.7), alpha = 0.3, show.legend = F) +
        stat_summary(aes(group = Database), fun = median, geom = "point", 
                    position = position_dodge(width = 0.7), size = 2, color = "black", show.legend = F) +
        geom_point(aes(color = Database, fill = Database),
               size = 2, alpha = 0.4, show.legend = T,
               position = position_jitterdodge(dodge.width = 0.7, jitter.width = 0.2, jitter.height = 0.01)) +
        ylab(y_label) + 
        xlab("NLCD Class") +
        labs(title = title_label) +
        theme_bw(base_size = 16) +
        theme(axis.text.x = element_text(angle = 310, vjust = .5, hjust = 0),
              axis.title = element_text(face = "bold"), 
              legend.title = element_text(face = "bold"), 
              legend.position = "right",
              plot.title = element_text(face = "bold", hjust = 0.5),
              plot.margin = unit(c(1,25,1,10), "pt")) +
        colScale +
        fillScale
    
    # Add Tukey test labels
    if(nrow(tukey_df) > 0) {
        tukey_plot_data <- tukey_df %>%
            mutate(Database = x, y.position = tot + 0.5)
        
        p <- p +
            geom_text(data = tukey_plot_data, 
                      aes(x = nlcdClass, y = y.position, label = Letters_Tukey, group = Database),
                      position = position_dodge(width = 0.7),
                      show.legend = F, color = 1, size = 4)
    }
    
    return(p)
}

# Create both panels
fig_before <- create_panel(classification_before, classification_tukey_before,
                           "% reads classified", 
                           "A. Before quality filtering")

fig_after <- create_panel(classification_after, classification_tukey_after,
                          "% reads classified", 
                          "B. After quality filtering")

# Combine panels
fig_classification_rates <- fig_before / fig_after +
    plot_layout(heights = c(1, 1), guides = "collect") &
    theme(legend.position = "right")

ggsave("manuscript_figures/classification_rates_by_biome.png", 
       fig_classification_rates, width = 12, height = 16, units = "in", dpi = 300)

